<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Critique See 'N Say</title>
  <style>
    :root{
      --bg:#0b1020;
      --panel:#0f1733;

      --toyYellow:#ffd35c;
      --toyYellow2:#f0b72f;
      --toyBlue:#1a7bd6;
      --toyBlue2:#0f58a6;
      --toyRed:#e94b3c;

      --text:#eaf0ff;
      --muted:#9fb2d6;

      --shadow: 0 20px 60px rgba(0,0,0,.45);
      --shadow2: 0 12px 26px rgba(0,0,0,.35);
    }

    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif;
      background: radial-gradient(1200px 900px at 20% 10%, #1b2a66 0%, var(--bg) 55%, #050713 100%);
      color:var(--text);
      min-height:100svh;
      display:grid;
      place-items:center;
      padding:24px;
    }

    .app{
      width:min(1060px, 100%);
      display:grid;
      grid-template-columns: 1.25fr .75fr;
      gap:24px;
      align-items:start;
    }
    @media (max-width: 860px){
      .app{grid-template-columns:1fr; gap:16px;}
    }

    .stage{
      position:relative;
      background: rgba(255,255,255,.04);
      border: 1px solid rgba(255,255,255,.08);
      border-radius: 24px;
      padding: 22px;
      box-shadow: var(--shadow);
      overflow:hidden;
    }

    /* ===== Toy silhouette: handle connected to base ===== */
    .toyFrame{
      position:relative;
      width:min(600px, 100%);
      margin:0 auto;
      padding-top: 10px;
      padding-bottom: 24px;
    }

    /* The whole connected "housing" layer */
    .housing{
      position:absolute;
      inset: 0;
      pointer-events:none;
      z-index:0;
    }

    /* Top handle bar */
    .toyHandleBar{
      position:absolute;
      left: 18%;
      right: 18%;
      top: 8px;
      height: 84px;
      border-radius: 26px 26px 34px 34px;
      background:
        radial-gradient(140px 80px at 50% 30%, rgba(255,255,255,.55), rgba(255,255,255,0) 60%),
        linear-gradient(180deg, var(--toyYellow) 0%, var(--toyYellow2) 100%);
      box-shadow: inset 0 -10px 0 rgba(0,0,0,.10), var(--shadow2);
      border: 1px solid rgba(0,0,0,.08);
    }
    .toyHandleBar:before{
      content:"";
      position:absolute;
      left: 16%;
      right: 16%;
      top: 18px;
      bottom: 16px;
      border-radius: 18px;
      background: rgba(255,255,255,.86);
      box-shadow: inset 0 0 0 10px rgba(0,0,0,.06);
    }

    /* Two connected legs (like the real toy) */
    .leg{
      position:absolute;
      top: 78px;
      width: 120px;
      height: 420px;
      border-radius: 40px;
      background: linear-gradient(180deg, var(--toyYellow) 0%, var(--toyYellow2) 100%);
      box-shadow: inset 0 -12px 0 rgba(0,0,0,.10), var(--shadow2);
      border: 1px solid rgba(0,0,0,.08);
      opacity: 0.98;
    }
    .leg.left{ left: 10%; }
    .leg.right{ right: 10%; }

    /* Base platform */
    .toyBase{
      position:absolute;
      left: 10%;
      right: 10%;
      bottom: 6px;
      height: 92px;
      border-radius: 30px;
      background: linear-gradient(180deg, var(--toyYellow) 0%, var(--toyYellow2) 100%);
      box-shadow: inset 0 -12px 0 rgba(0,0,0,.10), var(--shadow2);
      border: 1px solid rgba(0,0,0,.08);
    }

    /* Wheel area container (sits above housing) */
    .toy{
      position:relative;
      width:100%;
      aspect-ratio: 1 / 1;
      display:grid;
      place-items:center;
      z-index:1;
      /* push wheel down a bit so handle feels attached */
      margin-top: 88px;
      margin-bottom: 34px;
    }

    /* Pointer */
    .pointer{
      position:absolute;
      top: 18px;
      left: 50%;
      transform: translateX(-50%);
      width: 0; height: 0;
      border-left: 14px solid transparent;
      border-right: 14px solid transparent;
      border-top: 22px solid rgba(255,255,255,.95);
      filter: drop-shadow(0 6px 8px rgba(0,0,0,.35));
      z-index:6;
    }

    /* Ring */
    .ring{
      position:absolute;
      inset: 7.5%;
      border-radius: 50%;
      background:
        radial-gradient(circle at 50% 35%, rgba(255,255,255,.55) 0%, rgba(255,255,255,0) 46%),
        linear-gradient(180deg, #ffe08b 0%, var(--toyYellow) 55%, var(--toyYellow2) 100%);
      box-shadow:
        inset 0 0 0 10px rgba(0,0,0,.08),
        inset 0 -14px 18px rgba(0,0,0,.12),
        0 14px 26px rgba(0,0,0,.25);
      z-index:1;
    }

    /* Wheel: equal slices via conic-gradient */
    .wheel{
      position:absolute;
      inset: 12%;
      border-radius: 50%;
      overflow:hidden;
      transform: rotate(0deg);
      will-change: transform;
      box-shadow: inset 0 0 0 10px rgba(0,0,0,.10);
      z-index:2;
      background: rgba(255,255,255,.06);
    }
    .wheel::after{
      content:"";
      position:absolute;
      inset:0;
      background: radial-gradient(circle at 45% 30%, rgba(255,255,255,.22), rgba(0,0,0,.10));
      mix-blend-mode: overlay;
      pointer-events:none;
    }

    /* Icons layer (inside wheel, rotates with it) */
    .icons{
      position:absolute;
      inset:0;
      pointer-events:none;
    }
    .iconSlot{
      position:absolute;
      width: 68px;
      height: 68px;
      border-radius: 999px;
      display:grid;
      place-items:center;
      background: rgba(255,255,255,.82);
      box-shadow: 0 12px 18px rgba(0,0,0,.22);
      border: 6px solid rgba(255,255,255,.78);
    }
    .iconSlot svg{
      width: 38px;
      height: 38px;
      opacity: .92;
    }
    @media (max-width:520px){
      .iconSlot{ width:56px; height:56px; }
      .iconSlot svg{ width:32px; height:32px; }
    }

    /* Center */
    .center{
      position:absolute;
      inset: 35%;
      border-radius: 50%;
      background: radial-gradient(circle at 40% 35%, #ff7a6e 0%, var(--toyRed) 55%, #c73327 100%);
      box-shadow: inset 0 0 0 12px rgba(0,0,0,.10),
                  0 16px 28px rgba(0,0,0,.35);
      display:grid;
      place-items:center;
      z-index:5;
      user-select:none;
      touch-action: manipulation;
      cursor: default;
    }
    .center .badge{
      width: 76%;
      aspect-ratio: 1 / 1;
      border-radius: 50%;
      background: radial-gradient(circle at 40% 35%, #2fa0ff 0%, var(--toyBlue) 60%, var(--toyBlue2) 100%);
      box-shadow: inset 0 0 0 10px rgba(0,0,0,.12);
      display:grid;
      place-items:center;
      padding:12px;
      text-align:center;
      border: 1px solid rgba(255,255,255,.20);
    }
    .center .badge strong{
      display:block;
      font-size: 13px;
      letter-spacing:.7px;
      text-transform: uppercase;
    }
    .center .badge small{
      display:block;
      margin-top:6px;
      color: rgba(255,255,255,.86);
      font-weight: 700;
    }

    /* Pull string */
    .stringWrap{
      position:absolute;
      right: -10px;
      bottom: 18%;
      display:flex;
      align-items:center;
      gap:10px;
      z-index:7;
    }
    .string{
      width: 165px;
      height: 8px;
      border-radius: 999px;
      background: linear-gradient(90deg, rgba(255,255,255,.18), rgba(255,255,255,.78), rgba(255,255,255,.18));
      box-shadow: 0 10px 18px rgba(0,0,0,.25);
      transform-origin: left center;
    }
    .handle{
      width: 46px; height: 38px;
      border-radius: 12px;
      background: #ff5b5b;
      box-shadow: 0 12px 20px rgba(0,0,0,.25), inset 0 -5px 0 rgba(0,0,0,.12);
      border: 1px solid rgba(255,255,255,.25);
      cursor:pointer;
      display:grid;
      place-items:center;
      user-select:none;
      touch-action: manipulation;
    }
    .handle:active{ transform: translateY(1px); }
    .handle svg{opacity:.92}

    /* Panel */
    .panel{
      background: rgba(255,255,255,.04);
      border: 1px solid rgba(255,255,255,.08);
      border-radius: 24px;
      padding: 18px;
      box-shadow: var(--shadow);
    }
    .panel h1{ font-size: 18px; margin: 0 0 10px; letter-spacing:.2px; }
    .panel p{ margin: 0 0 12px; color: var(--muted); line-height: 1.35; font-size: 14px; }

    .row{ display:flex; gap:10px; flex-wrap:wrap; align-items:center; margin-top: 10px; }

    button{
      appearance:none;
      border: 1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.06);
      color: var(--text);
      padding: 10px 12px;
      border-radius: 12px;
      cursor:pointer;
      font-weight: 750;
      letter-spacing:.2px;
    }
    button:hover{ background: rgba(255,255,255,.10); }
    button:disabled{ opacity:.55; cursor:not-allowed; }

    .pill{
      display:flex;
      align-items:center;
      gap:8px;
      padding: 10px 12px;
      border-radius: 12px;
      border: 1px solid rgba(255,255,255,.14);
      background: rgba(0,0,0,.18);
      color: rgba(255,255,255,.88);
      font-size: 13px;
      font-weight: 700;
      user-select:none;
    }
    .pill input{ transform: scale(1.1); }

    textarea{
      width:100%;
      min-height: 200px;
      resize: vertical;
      border-radius: 14px;
      border: 1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.20);
      color: var(--text);
      padding: 12px;
      font-size: 13px;
      line-height:1.35;
      outline:none;
    }
    .hint{ margin-top:10px; font-size:12px; color: rgba(255,255,255,.65); line-height: 1.35; }

    .locked textarea, .locked #apply, .locked #editorLabel, .locked #formatHint { display:none; }

    /* Overlay */
    .overlay{
      position:fixed;
      inset:0;
      display:grid;
      place-items:center;
      background: rgba(0,0,0,.55);
      opacity:0;
      pointer-events:none;
      transition: opacity .18s ease;
      padding: 24px;
      z-index:50;
    }
    .overlay.show{ opacity:1; pointer-events:auto; }

    .overlayCard{
      width:min(860px, 100%);
      background: rgba(15, 23, 51, .92);
      border: 1px solid rgba(255,255,255,.12);
      border-radius: 22px;
      padding: 18px 18px 16px;
      box-shadow: var(--shadow);
      display:grid;
      gap: 12px;
    }
    .overlayCard .q{
      font-size: clamp(22px, 4vw, 38px);
      font-weight: 900;
      line-height:1.12;
      margin: 0;
    }
    .overlayCard .sub{ margin:0; color: rgba(255,255,255,.70); font-size: 13px; }
    .overlayImg{
      width: min(520px, 100%);
      aspect-ratio: 4 / 3;
      border-radius: 18px;
      background: rgba(255,255,255,.06);
      border: 1px solid rgba(255,255,255,.10);
      background-size: cover;
      background-position: center;
      display:none;
    }
    .overlayImg.show{ display:block; }
  </style>
</head>

<body>
  <div class="app">
    <div class="stage">
      <div class="toyFrame">

        <!-- Connected handle + legs + base -->
        <div class="housing" aria-hidden="true">
          <div class="toyHandleBar"></div>
          <div class="leg left"></div>
          <div class="leg right"></div>
          <div class="toyBase"></div>
        </div>

        <!-- Wheel -->
        <div class="toy" aria-label="Critique wheel">
          <div class="pointer" aria-hidden="true"></div>
          <div class="ring" aria-hidden="true"></div>

          <div id="wheel" class="wheel" role="img" aria-label="Spinning icon wheel">
            <div id="icons" class="icons" aria-hidden="true"></div>
          </div>

          <div id="center" class="center" aria-label="Center badge (long-press to unlock when locked)">
            <div class="badge">
              <div>
                <strong>Critique</strong>
                <small>Pull to ask</small>
              </div>
            </div>
          </div>

          <div class="stringWrap">
            <div id="string" class="string" aria-hidden="true"></div>
            <div id="handle" class="handle" title="Pull" role="button" aria-label="Pull the string">
              <svg width="22" height="22" viewBox="0 0 24 24" fill="none" aria-hidden="true">
                <path d="M12 5v14m0 0l-5-5m5 5l5-5" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
              </svg>
            </div>
          </div>
        </div>

      </div>
    </div>

    <aside id="panel" class="panel">
      <h1>Critique See ’N Say</h1>
      <p>Tap the pull handle to spin. It lands on an icon; the question appears large and speaks out loud.</p>

      <div class="row">
        <button id="spin">Spin</button>
        <button id="testVoice">Enable / Test voice</button>
        <button id="lockBtn">Lock editor</button>
      </div>

      <div class="row" style="margin-top:12px;">
        <label class="pill">
          <input id="noRepeats" type="checkbox" />
          No repeats until all used
        </label>

        <label class="pill">
          <input id="showOverlayImg" type="checkbox" checked />
          Show selected image in overlay
        </label>
      </div>

      <div id="editorLabel" style="font-weight:800; font-size:13px; margin-top:14px;">
        Questions (one per line)
      </div>
      <textarea id="questions"></textarea>

      <div id="formatHint" class="hint">
        Optional format: <b>Question | imageURL | iconKey</b><br/>
        iconKey: <i>small, heavy, light, sit, surface, change, risk, focus, quiet, intent, unresolved, notice</i><br/>
        Example: <i>Why is it so heavy? | https://example.com/heavy.jpg | heavy</i>
      </div>

      <div class="row">
        <button id="apply">Apply questions</button>
      </div>

      <div class="hint">
        Locked note: long-press the <b>center badge</b> ~0.8s to unlock.<br/>
        Voice note: on mobile, do “Enable / Test voice” once.
      </div>
    </aside>
  </div>

  <div id="overlay" class="overlay" role="dialog" aria-modal="true" aria-label="Selected question">
    <div class="overlayCard">
      <div id="overlayImg" class="overlayImg" aria-hidden="true"></div>
      <p class="q" id="overlayText">…</p>
      <p class="sub">Tap anywhere to dismiss.</p>
    </div>
  </div>

  <script>
    // ===== CONFIG =====
    // Minimum full rotations before stopping
    const MIN_FULL_ROTATIONS = 1;

    // ===== Icon library (inline SVG) =====
    const ICONS = {
      small: svg(`<circle cx="12" cy="12" r="7"/><path d="M5 12h14" stroke-width="2" fill="none"/>`),
      heavy: svg(`<path d="M7 10h10l-1 9H8l-1-9Z"/><path d="M9 10V7a3 3 0 0 1 6 0v3" fill="none" stroke-width="2"/>`),
      light: svg(`<path d="M12 3c3 4 3 7 0 11-3-4-3-7 0-11Z"/><path d="M6 19h12" fill="none" stroke-width="2"/>`),
      sit: svg(`<path d="M6 18h12" fill="none" stroke-width="2"/><path d="M8 16c2-3 6-3 8 0" fill="none" stroke-width="2"/><circle cx="12" cy="10" r="4"/>`),
      surface: svg(`<path d="M5 7h14M5 12h14M5 17h14" fill="none" stroke-width="2"/><path d="M7 5v14" fill="none" stroke-width="2"/>`),
      change: svg(`<path d="M7 7h10v10H7z"/><path d="M9 9l6 6M15 9l-6 6" fill="none" stroke-width="2"/>`),
      risk: svg(`<path d="M12 3l10 18H2L12 3Z"/><path d="M12 9v5" fill="none" stroke-width="2"/><circle cx="12" cy="17" r="1.2"/>`),
      focus: svg(`<circle cx="12" cy="12" r="8" fill="none" stroke-width="2"/><circle cx="12" cy="12" r="3"/>`),
      quiet: svg(`<path d="M7 10v4c0 2 2 4 5 4s5-2 5-4v-4" fill="none" stroke-width="2"/><path d="M9 8c1-2 5-2 6 0" fill="none" stroke-width="2"/>`),
      intent: svg(`<path d="M4 12h8" fill="none" stroke-width="2"/><path d="M10 8l4 4-4 4" fill="none" stroke-width="2"/><circle cx="16.5" cy="12" r="3.5"/>`),
      unresolved: svg(`<path d="M6 8c2-4 10-4 12 0" fill="none" stroke-width="2"/><path d="M6 16c2 4 10 4 12 0" fill="none" stroke-width="2"/><path d="M10 12h4" fill="none" stroke-width="2"/>`),
      notice: svg(`<path d="M2 12s4-6 10-6 10 6 10 6-4 6-10 6S2 12 2 12Z"/><circle cx="12" cy="12" r="2.5"/>`)
    };

    function svg(inner){
      return `<svg viewBox="0 0 24 24" fill="rgba(0,0,0,.75)" xmlns="http://www.w3.org/2000/svg" stroke="rgba(0,0,0,.75)">${inner}</svg>`;
    }

    // ===== Defaults =====
    const DEFAULT_ITEMS = [
      { text: "Why is it so small?", iconKey: "small" },
      { text: "Why is it so heavy?", iconKey: "heavy" },
      { text: "Why is it so light?", iconKey: "light" },
      { text: "Why does it sit like that?", iconKey: "sit" },
      { text: "What decision feels most intentional here?", iconKey: "intent" },
      { text: "What feels unresolved?", iconKey: "unresolved" },
      { text: "Where does the surface help (or fight) the form?", iconKey: "surface" },
      { text: "What would you change if you made it again?", iconKey: "change" },
      { text: "What’s the strongest part of this piece?", iconKey: "focus" },
      { text: "What’s the quietest part of this piece?", iconKey: "quiet" },
      { text: "What’s the piece asking the viewer to notice?", iconKey: "notice" },
      { text: "What’s one risk you could push further?", iconKey: "risk" }
    ];

    const WEDGE_COLORS = [
      "#ffd35c", "#bfe6ff", "#c7f2c4", "#ffd0e0",
      "#ffe6a6", "#cdd7ff", "#d2f7ff", "#ffd9b5"
    ];

    // ===== Elements =====
    const wheelEl = document.getElementById("wheel");
    const iconsEl = document.getElementById("icons");
    const handleEl = document.getElementById("handle");
    const stringEl = document.getElementById("string");
    const centerEl = document.getElementById("center");

    const overlayEl = document.getElementById("overlay");
    const overlayTextEl = document.getElementById("overlayText");
    const overlayImgEl = document.getElementById("overlayImg");

    const panelEl = document.getElementById("panel");
    const questionsTA = document.getElementById("questions");

    const applyBtn = document.getElementById("apply");
    const spinBtn = document.getElementById("spin");
    const testVoiceBtn = document.getElementById("testVoice");
    const lockBtn = document.getElementById("lockBtn");

    const noRepeatsChk = document.getElementById("noRepeats");
    const showOverlayImgChk = document.getElementById("showOverlayImg");

    // ===== State =====
    let items = [...DEFAULT_ITEMS];
    let isSpinning = false;
    let currentRotation = 0; // degrees
    let bag = []; // for no-repeats

    const LS = {
      locked: "sns_locked",
      noRepeats: "sns_norepeats",
      showOverlayImg: "sns_showOverlayImg",
      items: "sns_items_v3"
    };

    // ===== Audio (ratchet + thunk) =====
    let audioCtx = null;

    function ensureAudio(){
      if(!audioCtx){
        audioCtx = new (window.AudioContext || window.webkitAudioContext)();
      }
      if(audioCtx.state === "suspended") audioCtx.resume();
    }

    function clickTick(timeOffset = 0){
      if(!audioCtx) return;
      const t = audioCtx.currentTime + timeOffset;
      const o = audioCtx.createOscillator();
      const g = audioCtx.createGain();
      o.type = "square";
      o.frequency.setValueAtTime(900, t);
      g.gain.setValueAtTime(0.0001, t);
      g.gain.exponentialRampToValueAtTime(0.08, t + 0.001);
      g.gain.exponentialRampToValueAtTime(0.0001, t + 0.03);
      o.connect(g).connect(audioCtx.destination);
      o.start(t);
      o.stop(t + 0.035);
    }

    function thunk(timeOffset = 0){
      if(!audioCtx) return;
      const t = audioCtx.currentTime + timeOffset;
      const o = audioCtx.createOscillator();
      const g = audioCtx.createGain();
      o.type = "sine";
      o.frequency.setValueAtTime(160, t);
      o.frequency.exponentialRampToValueAtTime(60, t + 0.08);
      g.gain.setValueAtTime(0.0001, t);
      g.gain.exponentialRampToValueAtTime(0.22, t + 0.005);
      g.gain.exponentialRampToValueAtTime(0.0001, t + 0.10);
      o.connect(g).connect(audioCtx.destination);
      o.start(t);
      o.stop(t + 0.11);
    }

    // ===== Speech =====
    function speak(text){
      try{
        window.speechSynthesis.cancel();
        const u = new SpeechSynthesisUtterance(text);
        u.rate = 1.0; u.pitch = 1.0; u.volume = 1.0;
        const voices = window.speechSynthesis.getVoices?.() || [];
        const en = voices.find(v => /en/i.test(v.lang));
        if(en) u.voice = en;
        window.speechSynthesis.speak(u);
      }catch(e){}
    }

    function showOverlay(text, imgUrl){
      overlayTextEl.textContent = text;

      if(showOverlayImgChk.checked && imgUrl){
        overlayImgEl.style.backgroundImage = `url("${imgUrl}")`;
        overlayImgEl.classList.add("show");
      }else{
        overlayImgEl.classList.remove("show");
        overlayImgEl.style.backgroundImage = "";
      }
      overlayEl.classList.add("show");
    }
    overlayEl.addEventListener("click", () => overlayEl.classList.remove("show"));

    // ===== Editor parsing / serialization =====
    // Format: Question | imageURL | iconKey
    function serializeItems(list){
      return list.map(it => {
        const parts = [it.text];
        if(it.img) parts.push(it.img);
        if(it.iconKey) parts.push(it.iconKey);
        return parts.join(" | ");
      }).join("\n");
    }

    function parseItems(raw){
      const out = raw.split("\n").map(s => s.trim()).filter(Boolean).map(line => {
        const parts = line.split("|").map(p => p.trim()).filter(Boolean);
        const text = parts[0] ?? "";
        const img = parts[1] && parts[1].startsWith("http") ? parts[1] : undefined;
        const iconKey = parts[2] ? parts[2].toLowerCase() : undefined;
        return { text, img, iconKey };
      }).filter(x => x.text.trim().length > 0);
      return out;
    }

    function defaultIconKeyForText(text){
      const t = (text || "").toLowerCase();
      if(t.includes("small")) return "small";
      if(t.includes("heavy")) return "heavy";
      if(t.includes("light")) return "light";
      if(t.includes("sit")) return "sit";
      if(t.includes("surface")) return "surface";
      if(t.includes("change") || t.includes("again")) return "change";
      if(t.includes("risk")) return "risk";
      if(t.includes("intent")) return "intent";
      if(t.includes("unresolved")) return "unresolved";
      if(t.includes("quiet")) return "quiet";
      if(t.includes("notice") || t.includes("viewer")) return "notice";
      if(t.includes("strong")) return "focus";
      return "notice";
    }

    // ===== Wheel render =====
    function buildConicGradient(n){
      const step = 360 / n;
      const stops = [];
      for(let i=0;i<n;i++){
        const c = WEDGE_COLORS[i % WEDGE_COLORS.length];
        const a0 = i * step;
        const a1 = (i+1) * step;
        stops.push(`${c} ${a0}deg ${a1}deg`);
      }
      return `conic-gradient(from -90deg, ${stops.join(",")})`;
    }

    function buildWheel(){
      const n = Math.max(2, items.length);

      wheelEl.style.background = buildConicGradient(n);

      iconsEl.innerHTML = "";
      const slice = 360 / n;

      // stable pixel radius so icons don't disappear
      const wheelRect = wheelEl.getBoundingClientRect();
      const radiusPx = Math.min(wheelRect.width, wheelRect.height) * 0.34;

      for(let i=0;i<n;i++){
        const it = items[i];
        const key = (it.iconKey && ICONS[it.iconKey]) ? it.iconKey : defaultIconKeyForText(it.text);
        const svgMarkup = ICONS[key] || ICONS.notice;

        const slot = document.createElement("div");
        slot.className = "iconSlot";
        slot.innerHTML = svgMarkup;

        const angle = (i * slice) + (slice / 2); // wedge center

        slot.style.left = "50%";
        slot.style.top = "50%";
        slot.style.transform =
          `translate(-50%, -50%) rotate(${angle}deg) translate(0, ${-radiusPx}px) rotate(${-angle}deg)`;

        iconsEl.appendChild(slot);
      }
    }

    // rebuild on resize so radius stays correct
    let resizeTimer = null;
    window.addEventListener("resize", () => {
      clearTimeout(resizeTimer);
      resizeTimer = setTimeout(buildWheel, 120);
    });

    // ===== Deterministic selection =====
    function shuffle(arr){
      for(let i=arr.length-1;i>0;i--){
        const j = Math.floor(Math.random()*(i+1));
        [arr[i], arr[j]] = [arr[j], arr[i]];
      }
      return arr;
    }
    function refillBag(){
      bag = shuffle([...Array(items.length).keys()]);
    }
    function pickIndex(){
      if(!noRepeatsChk.checked){
        return Math.floor(Math.random() * items.length);
      }
      if(bag.length === 0) refillBag();
      return bag.pop();
    }

    // ===== Spin =====
    function randInt(min, max){
      return Math.floor(Math.random() * (max - min + 1)) + min;
    }
    function animatePull(){
      stringEl.animate(
        [{ transform: "scaleX(1)" }, { transform: "scaleX(1.28)" }, { transform: "scaleX(1)" }],
        { duration: 230, easing: "ease-out" }
      );
    }

    function spin(){
      if(isSpinning) return;
      if(items.length < 2) return;

      ensureAudio();

      isSpinning = true;
      spinBtn.disabled = true;
      applyBtn.disabled = true;

      animatePull();

      const n = items.length;
      const slice = 360 / n;

      const targetIndex = pickIndex();

      // Guarantee minimum full rotations
      const extraSpins = randInt(MIN_FULL_ROTATIONS, MIN_FULL_ROTATIONS + 3) * 360;

      // Align wedge center to pointer
      const targetCenter = targetIndex * slice + slice / 2;
      const jitter = (Math.random() * (slice * 0.10)) - (slice * 0.05);
      const targetRotation = extraSpins + (360 - (targetCenter % 360)) + jitter;

      const endRotation = currentRotation + targetRotation;

      // Ratchet ticks over the duration (ease-out feel)
      const totalMs = 3200; // matches CSS transition duration below
      const ticks = 22;
      for(let k=0;k<ticks;k++){
        const frac = k / ticks;
        const eased = 1 - Math.pow(1 - frac, 2.2);
        clickTick((eased * totalMs) / 1000);
      }

      wheelEl.style.transition = "transform 3.2s cubic-bezier(0.12, 0.78, 0.08, 1)";
      wheelEl.style.transform = `rotate(${endRotation}deg)`;

      const onDone = () => {
        currentRotation = endRotation % 360;

        thunk(0);

        const chosen = items[targetIndex];
        showOverlay(chosen.text, chosen.img);
        speak(chosen.text);

        isSpinning = false;
        spinBtn.disabled = false;
        applyBtn.disabled = false;
      };
      wheelEl.addEventListener("transitionend", onDone, { once: true });
    }

    // ===== Locking =====
    function setLocked(locked){
      panelEl.classList.toggle("locked", locked);
      lockBtn.textContent = locked ? "Unlock editor" : "Lock editor";
      try{ localStorage.setItem(LS.locked, locked ? "1" : "0"); }catch(e){}
    }
    lockBtn.addEventListener("click", () => {
      const locked = panelEl.classList.contains("locked");
      setLocked(!locked);
    });

    // Long-press center to unlock when locked
    let pressTimer = null;
    function startPress(){
      if(!panelEl.classList.contains("locked")) return;
      pressTimer = setTimeout(() => setLocked(false), 800);
    }
    function endPress(){
      if(pressTimer) clearTimeout(pressTimer);
      pressTimer = null;
    }
    centerEl.addEventListener("pointerdown", startPress);
    centerEl.addEventListener("pointerup", endPress);
    centerEl.addEventListener("pointercancel", endPress);
    centerEl.addEventListener("pointerleave", endPress);

    // ===== UI wiring =====
    applyBtn.addEventListener("click", () => {
      const next = parseItems(questionsTA.value);
      if(next.length < 2){
        alert("Add at least 2 questions (one per line).");
        return;
      }
      items = next;
      bag = [];
      buildWheel();
      try{ localStorage.setItem(LS.items, JSON.stringify(items)); }catch(e){}
    });

    spinBtn.addEventListener("click", spin);
    handleEl.addEventListener("click", spin);

    testVoiceBtn.addEventListener("click", () => {
      ensureAudio();
      speak("Voice enabled. Ready to critique.");
      showOverlay("Voice enabled. Ready to critique.", null);
      setTimeout(() => overlayEl.classList.remove("show"), 900);
    });

    noRepeatsChk.addEventListener("change", () => {
      bag = [];
      try{ localStorage.setItem(LS.noRepeats, noRepeatsChk.checked ? "1" : "0"); }catch(e){}
    });

    showOverlayImgChk.addEventListener("change", () => {
      try{ localStorage.setItem(LS.showOverlayImg, showOverlayImgChk.checked ? "1" : "0"); }catch(e){}
    });

    // ===== Init =====
    (function init(){
      try{
        const locked = localStorage.getItem(LS.locked) === "1";
        const nr = localStorage.getItem(LS.noRepeats) === "1";
        const soi = localStorage.getItem(LS.showOverlayImg);
        const saved = localStorage.getItem(LS.items);

        noRepeatsChk.checked = nr;
        showOverlayImgChk.checked = (soi !== "0");

        if(saved){
          const parsed = JSON.parse(saved);
          if(Array.isArray(parsed) && parsed.length >= 2){
            items = parsed.map(x => ({
              text: String(x.text ?? "").trim(),
              img: x.img ? String(x.img) : undefined,
              iconKey: x.iconKey ? String(x.iconKey) : undefined
            })).filter(x => x.text.length > 0);
          }
        }

        questionsTA.value = serializeItems(items.length ? items : DEFAULT_ITEMS);
        setLocked(locked);
      }catch(e){
        items = [...DEFAULT_ITEMS];
        questionsTA.value = serializeItems(DEFAULT_ITEMS);
        setLocked(false);
      }

      // Build once after layout is settled (wheelRect is needed for icon radius)
      requestAnimationFrame(() => buildWheel());

      if ("speechSynthesis" in window) {
        window.speechSynthesis.onvoiceschanged = () => {};
      }
    })();
  </script>
</body>
</html>
